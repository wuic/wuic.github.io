<!DOCTYPE html> <html manifest="/pages/1434292223242/advanced-tutorials.html.appcache" lang="en"> <head><link rel="preload" href="/pages/2861444051/00000000ABCF0FDFaggregate.css" as="stylesheet" />
<link rel="preload" href="/pages/4050995650/000000006B8EFF0Daggregate.css" as="stylesheet" />
<link rel="preload" href="/pages/1434292225086/bootstrap/css/a/../img/glyphicons-halflings.png" as="image" />
<link rel="preload" href="/pages/1434292225082/bootstrap/css/a/../img/glyphicons-halflings-white.png" as="image" />
<link rel="preload" href="/pages/1434292225136/wiki-css/a/../wiki-images/background.png" as="image" />
<link rel="preload" href="/pages/1434292225117/font-awesome/css/a/../font/fontawesome-webfont.eot" as="font" />
<link rel="preload" href="/pages/1434292225124/font-awesome/css/a/../font/fontawesome-webfont.woff" as="font" />
<link rel="preload" href="/pages/1434292225122/font-awesome/css/a/../font/fontawesome-webfont.ttf" as="font" />
<link rel="preload" href="/pages/1434292225147/000000006B8EFF0Dwiki-images/logo/favicon.ico" as="image" />
<link rel="preload" href="/pages/1781504629/00000000DEB4A605aggregate.js" as="script" />
 <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.2"> <title>Custom workflow</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400"> <link rel="stylesheet" type="text/css" href="/pages/2861444051/00000000ABCF0FDFaggregate.css" />
 </head> <body class="article toc2 toc-right"> <div id="header"> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#_custom_workflow">Custom workflow</a> <ul class="sectlevel2"> <li><a href="#_purpose">Purpose</a></li> <li><a href="#_configuration">Configuration</a></li> </ul> </li> <li><a href="#_extend_wuic">Extend WUIC</a> <ul class="sectlevel2"> <li><a href="#_why_extend">Why extend?</a></li> <li><a href="#_resolve_and_process_nuts_differently">Resolve and process nuts differently</a></li> <li><a href="#_add_support_for_templating_project">Add support for templating project</a></li> </ul> </li> </ul> </div> </div> <div id="content"> <link rel="stylesheet" type="text/css" href="/pages/4050995650/000000006B8EFF0Daggregate.css" />
<link rel="shortcut icon" href="/pages/1434292225147/000000006B8EFF0Dwiki-images/logo/favicon.ico" />
    <!--[if lt IE 9]><script src="../assets/js/html5shiv.js"></script><![endif]-->   <div class="masthead"> <div class="navbar"> <div class="navbar-inner"> <div class="container"> <ul class="nav" role="navigation"> <li><a href="index.html"><i class="icon-home"></i><span class="hidden-phone">&nbsp;Home</span></a></li> <li><a href="project.html"><i class="icon-star"></i><span class="hidden-phone">&nbsp;Project</span></a></li> <li class="active"><a href="documentation.html"><i class="icon-book"></i><span class="hidden-phone">&nbsp;Documentation</span></a></li> <li><a href="contact.html"><i class="icon-envelope"></i><span class="hidden-phone">&nbsp;Contact</span></a></li> <li><a href="https://github.com/wuic/wuic" target="_blank" title="Wuic Github"><i class="icon-github"></i><span class="hidden-phone">&nbsp;Github</span></a></li> <li><a href="https://twitter.com/wuic_project" target="_blank"><i class="icon-twitter"></i><span class="hidden-phone">&nbsp;Twitter</span></a></li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="_custom_workflow">Custom workflow</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="_purpose">Purpose</h3> <div class="paragraph"> <p>By default, WUIC uses transparently a default instance of each detected engine. Automatically, your nuts will be aggregated, inspected, compressed, etc, but this could be changed!</p> </div> <div class="paragraph"> <p>This tutorial shows how you can take the complete control over the engines WUIC uses when processing nuts.</p> </div> </div> <div class="sect2"> <h3 id="_configuration">Configuration</h3> <div class="paragraph"> <p>Imagine you want that your nuts are only compressed by <code>YUCompressor</code> and cached by <code>EhCache</code>. One possibility is to configure other engines to disable it but you can even remove them from the engines chain!</p> </div> <div class="paragraph"> <p>Let&#8217;s see the following configuration that defines nuts heaps imported with <code>Thymeleaf</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;heap id="css" dao-builder-id="myDao"&gt;
        &lt;nut-path&gt;css/foo.css&lt;/nut-path&gt;
    &lt;/heap&gt;
    &lt;heap id="js" dao-builder-id="myDao"&gt;
        &lt;nut-path&gt;js/foo.js&lt;/nut-path&gt;
    &lt;/heap&gt;</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;wuic:html-import workflowId="css" /&gt;
&lt;wuic:html-import workflowId="js" /&gt;</code></pre> </div> </div> <div class="paragraph"> <p>At this stage, you could think that the possible imports are based on the existing heaps. That&#8217;s wrong! Actually, when you import a set of nuts, this is done through a workflow. A workflow processes some heaps with particular engines. Why we did not declare them before? Because WUIC creates a workflow for each heap by default. Its ID is the heap ID so that&#8217;s why you could import some nuts with the ID of your heap.</p> </div> <div class="paragraph"> <p>Actually, to create a workflow, you need to refer to a workflow template which describes all the engines to be used. When a workflow is created automatically for a heap, WUIC use a default template with some default engines:</p> </div> <div class="ulist"> <ul> <li> <p>A cache based on a memory map for all type of nuts</p> </li> <li> <p>A text aggregator for scripts</p> </li> <li> <p>An image aggregator and an image compressor for images</p> </li> <li> <p>etc</p> </li> </ul> </div> <div class="paragraph"> <p>So if we want to specify specific engines in a workflow, we have to declare it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;workflow-templates&gt;
        &lt;workflow-template id="tpl"&gt;
            &lt;without&gt;
                &lt;engine-builder-id&gt;wuicDefaultMemoryMapCacheEngineBuilder&lt;/engine-builder-id&gt;
            &lt;/without&gt;
            &lt;engine-chain&gt;
                &lt;engine-builder-id&gt;wuicDefaultEhCacheEngineBuilder&lt;/engine-builder-id&gt;
                &lt;engine-builder-id&gt;wuicDefaultYuiCompressorJavascriptEngineBuilder&lt;/engine-builder-id&gt;
                &lt;engine-builder-id&gt;wuicDefaultYuiCompressorCssEngineBuilder&lt;/engine-builder-id&gt;
            &lt;/engine-chain&gt;
        &lt;/workflow-template&gt;
    &lt;/workflow-templates&gt;

    &lt;workflows&gt;
        &lt;workflow id-prefix="my-" workflow-template-id="tpl" heap-id-pattern=".*" /&gt;
    &lt;/workflows&gt;</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Note that we have excluded the cache based on a memory map because we only want to use <code>EhCache</code> to cache nuts</p> </li> <li> <p>As it is done for DAOs, WUIC creates default engine builders so you can refer there ID.</p> </li> <li> <p><code>id-prefix</code> is a string that prefix the workflow ID which will be followed by the heap ID.</p> </li> <li> <p><code>heap-id-pattern</code> is a regular expression which defines the heaps to be processed by the engines specified in this workflow.</p> </li> <li> <p>By default, compression is enabled on YUI Compressor engines</p> </li> <li> <p>By default, cache is enabled in EhCache engine which looks for a cache named <code>wuicCache</code> in a <code>ehcache.xml</code> file at the root of the classpath. If the cache is not found, it creates a default one.</p> </li> </ul> </div> <div class="paragraph"> <p>With this configuration, WUIC will pick up appropriate engines for the nuts to be processed. For instance, <code>YUICompressor</code> CSS minifier won&#8217;t be applied on a heap composed of Javascript nuts. Moreover, they will be chained according to their type. For instance, caching engine is already executed first in the chain of responsibility.</p> </div> <div class="ulist"> <ul> <li> <p>Note that if a heap is referenced in a custom workflow, then its default one won&#8217;t be created.</p> </li> <li> <p>Also note that default engine will be injected if they are not in conflict with a specified one. In this case, cache based on memory map won&#8217;t be injected because we already specify <code>EhCache</code> support.</p> </li> </ul> </div> <div class="paragraph"> <p>Finally, you will import your heap through your custom workflow like that:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;wuic:html-import workflowId="my-css" /&gt;
&lt;wuic:html-import workflowId="my-js" /&gt;</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="_extend_wuic">Extend WUIC</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="_why_extend">Why extend?</h3> <div class="paragraph"> <p>You may extend WUIC for several purposes:</p> </div> <div class="ulist"> <ul> <li> <p>Create a new way to access nuts, this is done with a <a href="http://wuic.github.io/apidocs/com/github/wuic/nut/dao/NutDao.html">DAO</a></p> </li> <li> <p>Create a new nut processor, this is done with an <a href="http://wuic.github.io/apidocs/com/github/wuic/engine/Engine.htm">engine</a></p> </li> <li> <p>Create a support for a templating project to write HTML statements that load processed nuts</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="_resolve_and_process_nuts_differently">Resolve and process nuts differently</h3> <div class="paragraph"> <p>Both DAO (TODO: migrate <a href="https://github.com/wuic/wuic/wiki/Data-Access-Object" class="bare">https://github.com/wuic/wuic/wiki/Data-Access-Object</a>) and Engines (TODO: migrate <a href="https://github.com/wuic/wuic/wiki/Engine-configuration" class="bare">https://github.com/wuic/wuic/wiki/Engine-configuration</a>) can be configured in a XML configuration file. You can also do it with [Java Config](<a href="https://github.com/wuic/wuic/wiki/Configuring-with-Java-Config#use-the-contextbuilder" class="bare">https://github.com/wuic/wuic/wiki/Configuring-with-Java-Config#use-the-contextbuilder</a>).</p> </div> <div class="paragraph"> <p>To do it, WUIC provides its own annotation processor architecture which detects all classes:</p> </div> <div class="ulist"> <ul> <li> <p>implementing <code>NutDao</code>, annotated <a href="http://wuic.github.io/apidocs/com/github/wuic/nut/dao/NutDaoService.html">@NutDaoService</a> and declared in package <code>com.github.wuic.dao</code></p> </li> <li> <p>extending <code>Engine</code>, annotated <a href="http://wuic.github.io/apidocs/com/github/wuic/engine/EngineService.html">@EngineService</a> and declared in package <code>com.github.wuic.engine</code></p> </li> </ul> </div> <div class="paragraph"> <p>So you can create a new DAO like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">package com.github.wuic.dao;

@NutDaoService
public class MyNutDao extends AbstractNutDao {
   ...
}</code></pre> </div> </div> <div class="paragraph"> <p>and an engine like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">package com.github.wuic.engine;

@EngineService(injectDefaultToWorkflow = true)
public class MyEngine extends NodeEngine {
   ...
}</code></pre> </div> </div> <div class="paragraph"> <p>In this last example you can see the <code>injectDefaultToWorkflow</code> annotation attribute that indicates that this engine will be in any workflow by default or not</p> </div> <div class="paragraph"> <p>Note that the code above uses base class that help you to implement <code>NutDao</code> interface and extend <code>Engine</code> class. You will find a lot of helpers in the javadoc:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://wuic.github.io/apidocs/com/github/wuic/engine/core/package-summary.html">Abstract classes</a> for engine with different purpose (caching, aggregating, compressing, etc)</p> </li> <li> <p><a href="http://wuic.github.io/apidocs/com/github/wuic/nut/AbstractNutDao.html">AbstractNutDao</a> for DAO creation</p> </li> </ul> </div> <div class="paragraph"> <p>Each engine and DAO needs to be configured differently so your class may expose a constructor expecting several parameters. You need in that case to rely on <a href="http://wuic.github.io/apidocs/com/github/wuic/config/package-summary.html">com.github.wuic.config</a> package which contains:</p> </div> <div class="ulist"> <ul> <li> <p><code>@ConfigConstructor</code> annotation for you constructor</p> </li> <li> <p>Annotations for each parameter regarding their type: <code>String</code>, <code>Integer</code>, <code>Boolean</code> or more global <code>Object</code></p> </li> </ul> </div> <div class="paragraph"> <p>For instance, an engine compressing nuts will looks like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">    @EngineService(injectDefaultToWorkflow = true)
    public class MyCompressEngine extends NodeEngine {

        @ConfigConstructor
        public MyCompressEngine(
                @BooleanConfigParam(propertyKey = "c.g.wuic.engine.compress", defaultValue = true)
                Boolean compress) {
        }

        @Override
        public List&lt;NutType&gt; getNutTypes() {
            return Arrays.asList(NutType.values());
        }

        @Override
        public EngineType getEngineType() {
            return EngineType.CACHE;
        }

        @Override
        protected List&lt;ConvertibleNut&gt; internalParse(EngineRequest request) throws WuicException {
            return request.getNuts();
        }

        @Override
        public Boolean works() {
            return true;
        }
    }</code></pre> </div> </div> <div class="paragraph"> <p><a href="http://wuic.github.io/apidocs/com/github/wuic/ApplicationConfig.html">ApplicationConfig</a> already contains a lot of configuration keys that you can reuse. This is required to let WUIC build the object for you regarding the properties provided in <code>XML</code> or <code>Java Config</code>. With the previous sample, you can now do something like that in XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;wuic&gt;
   &lt;engine-builders&gt;
       &lt;engine-builder type="MyCompressEngineBuilder"&gt;
           &lt;property key="c.g.wuic.engine.compress"&gt;false&lt;/property&gt;
       &lt;/engine-builder&gt;
   &lt;/engine-builders&gt;
&lt;/wuic&gt;</code></pre> </div> </div> <div class="paragraph"> <p>WUIC generates a builder identified by <code>[EngineName]Builder</code> and by default injects a default instance identified by <code>wuicDefault[BuilderName]</code> into the workflow. The previous configuration simply changes the default value (<code>true</code> to <code>false</code>).</p> </div> <div class="paragraph"> <p>You will find several extensions already provided <a href="https://github.com/wuic/wuic-extensions">here</a>.</p> </div> </div> <div class="sect2"> <h3 id="_add_support_for_templating_project">Add support for templating project</h3> <div class="paragraph"> <p>WUIC already provides support for <code>JSP</code> and <code>Thymeleaf</code> users (<a href="tutorials.html">see tutorials</a>).</p> </div> <div class="paragraph"> <p>Both support address the same issues:</p> </div> <div class="ulist"> <ul> <li> <p>How to generate 1 HTTP request to load an aggregate result vs N HTTP requests when aggregation is disabled</p> </li> <li> <p>How to manage configurations directly injected into the template and cache it to improve performances</p> </li> </ul> </div> <div class="sect3"> <h4 id="_generate_script_import">Generate script import</h4> <div class="paragraph"> <p>To generate script import, you need to loop over the list returned by the workflow process:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">            final List&lt;ConvertibleNut&gt; nuts = facade.runWorkflow(workflowId, ProcessContext.DEFAULT);

            for (final ConvertibleNut nut : nuts) {
                final String i = HtmlUtil.writeScriptImport(nut, IOUtils.mergePath(facade.getContextPath(), workflowId));
            }</code></pre> </div> </div> <div class="paragraph"> <p>Regarding your configuration, the process for a particular workflow will return a different result. For instance, the list will contain only one element per script type if aggregation is enabled, many otherwise.</p> </div> </div> <div class="sect3"> <h4 id="_allow_configuration_from_templating">Allow configuration from templating</h4> <div class="paragraph"> <p>You can also use the facade to specify additional configurations through templating support. You can rely on <a href="http://wuic.github.io/apidocs/com/github/wuic/ContextBuilderConfigurator.html">ContextBuilderConfigurator</a> to configure the facade. For instance, imagine a <code>Reader</code> points to the XML declared inside your template, then you can inject it like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">            facade.configure(new ReaderXmlContextBuilderConfigurator(reader,
                    toString(),
                    facade.allowsMultipleConfigInTagSupport(),
                    ProcessContext.DEFAULT));</code></pre> </div> </div> <div class="paragraph"> <p>Note: <code>wuicFacade.allowsMultipleConfigInTagSupport()</code> returns the <a href="http://wuic.github.io/apidocs/com/github/wuic/ApplicationConfig.html#WUIC_SERVLET_MULTIPLE_CONG_IN_TAG_SUPPORT">setting</a> that allows to configure only once (production mode) or multiple times (development mode).</p> </div> <div class="paragraph"> <p>You will find full samples in <a href="https://github.com/wuic/wuic/tree/wuic-0.5.x-snapshot/wuic/tag">JSP</a> and <a href="https://github.com/wuic/wuic-extensions/tree/wuic-0.5.x-snapshot/thymeleaf">Thymeleaf</a> support.</p> </div> <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script> <script type="text/javascript" src="/pages/1781504629/00000000DEB4A605aggregate.js"></script>
  </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2015-06-07 11:43:33 +01:00 </div> </div> </body> </html>